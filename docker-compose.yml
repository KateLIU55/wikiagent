version: "3.9"

services:
  crawler:
    build: ./crawler
    container_name: crawler
    volumes:
      - ./crawler:/app
      - ./data:/data
      - ./config:/config
    environment:
      CRAWL_CFG: /config/whitelist.yml
      DB_PATH: /data/wiki.sqlite
      TZ: "America/Los_Angeles"     # Pacific Time
    command: python app.py
    networks: [wikinet]
    restart: unless-stopped


  extractor:
    build: ./extractor
    container_name: extractor
    volumes:
      - ./extractor:/app
      - ./data:/data
    environment:
      BRAIN_BASE_URL: http://brain:8000
      DB_PATH: /data/wiki.sqlite
    command: python app.py
    networks: [wikinet]
    depends_on:
      - brain
      - db

  summarizer:
    build: ./summarizer
    container_name: summarizer
    volumes:
      - ./summarizer:/app
      - ./data:/data
    environment:
      # --- Tianâ€™s remote endpoint ---
      LLM_BASE_URL: http://anjso.ddns.net:13001/api/v1/openai
      LLM_API_KEY: ${LLM_API_KEY}     # ANJSO Key
      LLM_MODEL: anjso
      # LLM_BASE_URL: http://brain:8000/v1
      # LLM_API_KEY: ${LLM_API_KEY}
      # LLM_MODEL: meta-llama-3.1-8b-instruct
      DATA_DIR: /data
      IDLE_INTERVAL: 60
    command: python app.py
    networks: [wikinet]
    depends_on:
      - extractor

  publisher:
    build: ./publisher
    container_name: publisher
    volumes:
      - ./publisher:/app
      - ./data:/data
      - ./site:/site
    environment:
      BRAIN_BASE_URL: http://brain:8000
      DB_PATH: /data/wiki.sqlite
      DATA_DIR: /data
      SUMMARY_DIR: /data/summarized
      SITE_DIR: /site
      WIKI_WORKDIR: /tmp/wiki
      DEPLOY: "0"
    command: python app.py
    networks: [wikinet]
    depends_on:
      - brain
      - db

  db:
    image: busybox:latest
    container_name: db
    command: sh -c "mkdir -p /data && tail -f /dev/null"
    volumes:
      - ./data:/data
    networks: [wikinet]
    restart: unless-stopped

  brain:
    build: ./brain
    container_name: brain
    environment:
      DB_PATH: /data/wiki.sqlite
      LLM_API_BASE: http://anjso.ddns.net:13001/api/v1/openai
      LLM_API_KEY: ${LLM_API_KEY}
      MODEL: anjso
    volumes:
      - ./data:/data
    depends_on:
      - db
    networks: [wikinet]
    restart: unless-stopped
    ports:
      - "8000:8000"

  wiki:
    image: busybox:latest
    container_name: wiki
    environment:
      TIDDLERS_DIR: /data/tiddlers
      SITE_DIR: /site
      DB_PATH: /data/wiki.sqlite
      BRAIN_BASE_URL: http://brain:8000
    volumes:
      - ./data:/data
      - ./site:/site
    depends_on:
      - brain
      - db
    networks: [wikinet]
    restart: unless-stopped
    command: sh -c "mkdir -p /site && tail -f /dev/null"

networks:
  wikinet:
